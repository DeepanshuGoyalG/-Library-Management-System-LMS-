{% extends "base.html" %}
{% block content %}

<div class="container" style="max-width: 700px; margin-top: 40px;">
    <h2>{{ book.title }}</h2>
    <p><strong>Author:</strong> {{ book.author }}</p>
    <p><strong>Category:</strong> {{ book.category }}</p>
    <p><strong>Available Quantity:</strong> {{ book.quantity }}</p>
    <hr>

    <!-- Average Rating -->
    {% if book.reviews %}
        {% set avg = (book.reviews | map(attribute='rating') | sum) / (book.reviews | length) %}
        <p><strong>Average Rating:</strong> {{ "%.1f"|format(avg) }}/5 ⭐</p>
    {% else %}
        <p><em>No ratings yet.</em></p>
    {% endif %}

    <hr>

    <!-- Submit a Review -->
    {% if current_user.is_authenticated %}
        <h4>Leave a Review:</h4>
        <form action="{{ url_for('user.submit_review', book_id=book.id) }}" method="POST" style="margin-bottom: 30px;">
            <label>Rating (1–5):</label><br>
            <input type="number" name="rating" min="1" max="5" required><br><br>

            <label>Comment:</label><br>
            <textarea name="comment" rows="3" cols="50" placeholder="Write your feedback here..." required></textarea><br><br>

            <button type="submit" class="btn btn-primary">Submit Review</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('auth.login') }}">Login</a> to leave a review.</p>
    {% endif %}

    <hr>

    <!-- Display Existing Reviews -->
    <h4>User Reviews:</h4>
    {% if book.reviews %}
        {% for review in book.reviews %}
            <div class="card" style="padding: 10px; margin-bottom: 10px;">
                <strong>{{ review.user.name }}</strong> 
                <span style="color: #f5c518;">⭐ {{ review.rating }}/5</span><br>
                <em>{{ review.comment }}</em><br>
                <small>{{ review.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
        {% endfor %}
    {% else %}
        <p>No reviews yet. Be the first to review this book!</p>
    {% endif %}

    <a href="{{ url_for('user.user_dashboard') }}" class="btn btn-secondary">⬅ Back to Dashboard</a>
</div>

{% endblock %}
